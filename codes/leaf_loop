#!/bin/bash
set -e

LeafcutterLocDefault=~/leafcutter/
MinimumClusteringDefault=30
LengthMaximumDefault=100000
RatioMinimumDefault=0.001
OutputDirectoryDefault=~/leaf_out/
PCDefault=10
OutputPrefixPrefixDefault=leafcutter

#also needs an input option default can be set to the fastq_list_star.txt generated by star
#update -m, 
#-l, and 
#-o as options - also add 
#-r -> -w
#-p -> -r
#add -p option note that this option is different from the -p option from clustering

while :
do
    case "$1" in
      -l | --lengthmaximum) #maximum length of introns to be used in clustering
      	  LengthMaximum="$2"
	  shift 2
	  ;;
      -o | --outputprefix) #prefix of intron
      	  OutputPrefix="$2"
	  shift 2
	  ;;
      -p | --principalcomponents)
	  PC="$2"
	  shift 2
	  ;;
      -r | --ratiominimum)
      	  RatioMinimum="$2"
	  shift 2
	  ;;
      -w | --writeto) #write leafcutter clustering to this directory
      	  OutputDirectory="$2"
	  shift 2
      	  ;;
      -*) #unknown 
	  echo "Error: Unknown option: $1" >&2
	  exit 1
	  ;;
      *)  # No more options
	  shift
	  break
	  ;;
     esac
done

#checks need to go here

PATH=$PATH:"${LeafcutterLoc}"/scripts

#should add a check for if a particular sample has already had junction files made for it and skip it

if [ -d ~/test_runs/juncfiles ]
then 
	rm -r ~/test_runs/juncfiles
fi 

mkdir ~/test_runs/juncfiles # make a directory where the outputs will go - also update as an option

cat fastq_list_star.txt | while read line #iterate through the list
do
	Sample=$( echo "${line}" | cut -f 1 -d$'\t' )
	echo Converting "${Sample}" associated Aligned.out.bam to "${Sample}.junc"
	sh $LeafcutterLoc/scripts/bam2junc.sh ~/test_runs/"${Sample}_star"/Aligned.out.bam ~/test_runs/juncfiles/"${Sample}.junc"
	echo "${Sample}.junc" >> ~/test_runs/juncfiles/juncfiles.txt
done

python "${LeafcutterLoc}"/clustering/leafcutter_cluster.py -j ~/test_runs/juncfiles/juncfiles.txt -m 50 -o "${out}" -l 500000
zcat "${out}_perind.counts.gz" | grep "chr" > "${out}"_filtered_perind.counts.gz #filtering step - removes unmapped loci that woukld break leafcutter
#note this line requires full path
/usr/local/bin/anaconda2/bin/python "${LeafcutterLoc}"/scripts/prepare_phenotype_table.py ~/test_runs/juncfiles/renamed_filt_perind.counts.gz -p 10
